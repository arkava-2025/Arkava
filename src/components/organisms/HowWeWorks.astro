---
import Section from '@/components/atoms/Section.astro';
import Title from '@/components/atoms/Title.astro';
import Container from '../molecules/Container.astro';

const { whatsapp } = Astro.props as { whatsapp?: string };
const waNumber = (whatsapp ?? '573016075815').replace(/\D/g, '');
const waText = encodeURIComponent(
  'Bienvenido a Arkava Quiero iniciar un proyecto',
);

const steps = [
  {
    id: 'Evaluacion Tecnica',
    number: '01',
    title: 'Evaluacion Tecnica',
    tooltip:
      'Cada proyecto comienza con una mirada experta. Analizamos el espacio, escuchamos tus ideas y comprendemos la esencia de lo que quieres lograr.Nuestro propósito: transformar tu visión en un concepto arquitectónico sólido y posible.',
    position: 'above' as const,
  },
  {
    id: 'Planeacion y Presupuesto',
    number: '02',
    title: 'Planeacion y Presupuesto',
    tooltip:
      'Convertimos la idea en un plan claro. Diseñamos cada detalle, seleccionamos los materiales adecuados y definimos un presupuesto transparente que equilibra estética, calidad y funcionalidad.',
    position: 'below' as const,
  },
  {
    id: 'Ejecucion',
    number: '03',
    title: 'Ejecucion',
    tooltip:
      'Aquí tu proyecto cobra vida. Nuestro equipo coordina cada etapa con precisión, cuidando los tiempos, los acabados y la armonía del resultado.',
    position: 'above' as const,
  },
  {
    id: 'Supervision y Control',
    number: '04',
    title: 'Supervision y Control',
    tooltip:
      'Cada detalle merece ser cuidado con precisión. Por eso, acompañamos cada etapa con una supervisión dedicada y personalizada, asegurando que todo se realice según lo acordado y que los acabados reflejen la elegancia, el orden y la calidad que definen a Arkava.',
    position: 'below' as const,
  },
  {
    id: 'Entrega final',
    number: '05',
    title: 'Entrega final',
    tooltip:
      'Entregamos tu proyecto a satisfacción, verificando que cada detalle cumpla con los estándares acordados y refleje la calidad que prometimos desde el inicio. Un resultado impecable, listo para disfrutarse.',
    position: 'above' as const,
  },
];
---

<Section style="w-full bg-[#1f1f23]">
  <Container style="flex-col items-center">
    <!-- Optional heading -->
    <Title title="Nuestro proceso" style="mb-16 text-white" />

    <!-- Timeline container -->
    <div class="relative w-full">
      <!-- Mobile: Vertical line on the left -->
      <div
        class="sm:hidden absolute left-6 top-0 bottom-0 w-0.5 bg-gradient-to-b from-[#AE9A91]/20 via-[#AE9A91]/40 to-[#AE9A91]/20"
      >
      </div>

      <!-- Desktop: Horizontal line - positioned to align with desktop markers -->
      <div
        class="hidden sm:flex absolute left-0 right-0 items-center pointer-events-none"
        style="top: 50%; transform: translateY(-50%);"
      >
        <div
          class="mx-6 h-0.5 bg-gradient-to-r from-[#AE9A91]/20 via-[#AE9A91]/40 to-[#AE9A91]/20 w-full"
        >
        </div>
      </div>

      <!-- Steps: Mobile vertical timeline, Desktop horizontal -->
      <ul
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-8 sm:gap-0 relative z-10 pl-0 sm:pl-0 sm:min-h-[200px]"
      >
        {
          steps.map((step) => (
            <li
              class="sm:w-1/5 flex flex-col sm:items-center h-full group relative"
              id={`step-${step.id}`}
            >
              {/* Desktop title above (only when position === 'above') */}
              {step.position === 'above' && (
                <div class="relative pb-4 hidden sm:flex sm:h-6 sm:items-center">
                  <button
                    class="text-sm font-medium text-[#AE9A91] focus:outline-none hover:text-[#E35205] transition-colors"
                    aria-describedby={`tip-${step.id}`}
                    type="button"
                  >
                    {step.number} {step.title}
                  </button>
                </div>
              )}

              {/* Placeholder for spacing when title is below on desktop */}
              {step.position === 'below' && (
                <span class="hidden sm:block mb-4 h-2">&nbsp;</span>
              )}

              {/* Mobile Layout: Accordion style */}
              <div class="sm:hidden w-full">
                <div class="flex items-start gap-4 w-full">
                  {/* Mobile Marker */}
                  <div class="relative flex-shrink-0">
                    <div class="w-12 h-12 rounded-full border-2 border-[#E35205] flex items-center justify-center bg-transparent">
                      <div class="w-3 h-3 rounded-full bg-[#E35205]" />
                    </div>
                  </div>

                  {/* Mobile Content - Clickable Header */}
                  <div class="flex-1 pt-2">
                    <button
                      class="accordion-trigger w-full text-left text-sm font-medium text-[#AE9A91] focus:outline-none hover:text-[#E35205] transition-colors flex items-center justify-between"
                      data-step-id={step.id}
                      type="button"
                      aria-expanded="false"
                      aria-controls={`accordion-content-${step.id}`}
                    >
                      <span>
                        {step.number} {step.title}
                      </span>
                      <svg
                        class="accordion-icon w-4 h-4 transition-transform duration-200"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Mobile Accordion Content */}
                <div
                  id={`accordion-content-${step.id}`}
                  class="accordion-content ml-16 mt-3 overflow-hidden transition-all duration-300 ease-in-out"
                  style="max-height: 0;"
                  aria-hidden="true"
                >
                  <div class="pb-4">
                    <div class="rounded bg-[#fff] px-4 py-3 text-sm text-gray-900 shadow-lg ring-1 ring-black/10">
                      {step.tooltip}
                    </div>
                  </div>
                </div>
              </div>

              {/* Desktop Marker (hidden on mobile) */}
              <div class="hidden sm:block relative">
                <button
                  class="w-12 h-12 rounded-full border-2 border-[#E35205] flex items-center justify-center bg-transparent hover:bg-[#E35205]/10 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#E35205]/50"
                  aria-describedby={`tip-${step.id}`}
                  type="button"
                >
                  <div class="w-3 h-3 rounded-full bg-[#E35205]" />
                </button>

                {/* Desktop Tooltip */}
                <div
                  role="tooltip"
                  id={`tip-${step.id}-desktop`}
                  class={`pointer-events-none absolute left-1/2 -translate-x-1/2 rounded bg-[#fff] px-3 py-2 text-xs text-gray-900 opacity-0 shadow-lg ring-1 ring-black/10 transition-opacity group-hover:opacity-100 group-focus-within:opacity-100 w-[250px] z-20 ${step.position === 'above' ? 'top-full mt-2' : '-top-2 -translate-y-full'}`}
                >
                  {step.tooltip}
                </div>
              </div>

              {/* Desktop Bottom title: only for desktop when position === 'below' */}
              <div
                class={`hidden sm:block relative mt-0 ${step.position === 'below' ? 'sm:min-h-[1.5rem] sm:flex sm:items-center' : ''}`}
              >
                {step.position === 'below' && (
                  <button
                    class="text-sm font-medium text-[#AE9A91] focus:outline-none hover:text-[#E35205] transition-colors"
                    aria-describedby={`tip-${step.id}-desktop`}
                    type="button"
                  >
                    {step.number} {step.title}
                  </button>
                )}
              </div>

              {/* Bottom spacer to balance height on desktop when title is above */}
              {step.position === 'above' && (
                <span class="hidden sm:block h-6" />
              )}
            </li>
          ))
        }
      </ul>
    </div>

    <!-- CTA Button -->
    <div class="mt-16">
      <a
        href={`https://wa.me/${waNumber}?text=${waText}`}
        class="inline-block px-8 py-3 rounded-md border-2 border-[#E35205] text-[#E35205] font-medium hover:bg-[#E35205] hover:text-white transition-colors duration-200"
      >
        Iniciemos juntos
      </a>
    </div>
  </Container>
</Section>

<script>
  // Accordion functionality for mobile
  document.addEventListener('DOMContentLoaded', function () {
    const accordionTriggers = document.querySelectorAll('.accordion-trigger');

    accordionTriggers.forEach((trigger) => {
      trigger.addEventListener('click', function (event) {
        const target = event.currentTarget as HTMLElement;
        if (!target) return;

        const stepId = target.getAttribute('data-step-id');
        const content = document.getElementById(
          `accordion-content-${stepId}`,
        ) as HTMLElement;
        const icon = target.querySelector('.accordion-icon') as HTMLElement;
        const isExpanded = target.getAttribute('aria-expanded') === 'true';

        if (!content || !icon) return;

        // Close all other accordions first
        accordionTriggers.forEach((otherTrigger) => {
          if (otherTrigger !== target) {
            const otherStepId = otherTrigger.getAttribute('data-step-id');
            const otherContent = document.getElementById(
              `accordion-content-${otherStepId}`,
            ) as HTMLElement;
            const otherIcon = otherTrigger.querySelector(
              '.accordion-icon',
            ) as HTMLElement;

            if (otherContent && otherIcon) {
              otherTrigger.setAttribute('aria-expanded', 'false');
              otherContent.setAttribute('aria-hidden', 'true');
              otherContent.style.maxHeight = '0';
              otherIcon.style.transform = 'rotate(0deg)';
            }
          }
        });

        // Toggle current accordion
        if (isExpanded) {
          // Close current
          target.setAttribute('aria-expanded', 'false');
          content.setAttribute('aria-hidden', 'true');
          content.style.maxHeight = '0';
          icon.style.transform = 'rotate(0deg)';
        } else {
          // Open current
          target.setAttribute('aria-expanded', 'true');
          content.setAttribute('aria-hidden', 'false');
          content.style.maxHeight = content.scrollHeight + 'px';
          icon.style.transform = 'rotate(180deg)';
        }
      });
    });
  });
</script>
